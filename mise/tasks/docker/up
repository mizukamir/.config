#!/usr/bin/env bash
#MISE description="コンテナがあれば入り、なければビルドして起動（普段はこれ）"
#MISE render = false

GH_TOKEN=$(gh auth token)

# --- OrbStack稼働チェック ---
# Dockerデーモンが応答するか判断
if ! docker info > /dev/null 2>&1; then
    echo "Error: Docker daemon is not running."
    echo "Please launch OrbStack app first."
    exit 1
fi

if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container exists. Starting..."
    docker start -ai "$CONTAINER_NAME"
else
    echo "Container not found. Building and creating..."
    if ! docker image inspect "$IMAGE_NAME" > /dev/null 2>&1; then
        mise run docker:build
    fi

    # /run/host-services/ssh-auth.sock はMac上には見えないが
    # docker run の引数として渡すと OrbStack が内部で解釈する
    # -p 5173:5173       : Vite (Frontend)
    # -p 3000:3000       : Node.js系など
    # -p 5432:5432       : PostgreSQL (DBクライアント接続用)
    # -p 8000-8010:8000-8010 : Django(8000) + その他予備10個
    docker run -it \
        -p 5173:5173 \
        -p 3000:3000 \
        -p 5432:5432 \
        -p 8000-8010:8000-8010 \        
        -e GH_TOKEN="$GH_TOKEN" \
        -v "/run/host-services/ssh-auth.sock:/ssh-agent" \
        -e SSH_AUTH_SOCK="/ssh-agent" \
        --name "$CONTAINER_NAME" "$IMAGE_NAME"
fi
